<?xml version="1.0"?>

<?xml-stylesheet href="chrome://global/skin/global.css"?>
<?xml-stylesheet href="chrome://tabmixplus/content/preferences/preferences.css"?>
<?xml-stylesheet href="chrome://tabmixplus/skin/preferences/preferences.css"?>

<?xml-stylesheet href="chrome://tabmixplus/skin/preferences.css"?>
<?xml-stylesheet href="chrome://tabmixplus/skin/shortcuts.css"?>

<!DOCTYPE prefwindow [
<!ENTITY % pref-tabmixDTD SYSTEM "chrome://tabmixplus/locale/pref-tabmix.dtd">
%pref-tabmixDTD;
<!ENTITY % tabmixDTD SYSTEM "chrome://tabmixplus/locale/tabmix.dtd">
%tabmixDTD;
]>

<prefwindow type="prefwindow" class="prefwindow"
            id="TabMIxPreferences"
            windowtype="mozilla:tabmixopt"
            title="&page.header.title;"
            xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
            autosize="true"
            onload="customElements.define('prefwindow', PrefWindow); if (window.toString() == '[object ChromeWindow]') window.sizeToContent();"
            ondialogaccept="gPrefWindow.deinit();"
            ondialogcancel="gPrefWindow.deinit();"
            ondialogextra1="gPrefWindow.onApply();"
            ondialoghelp="openHelp();"
            buttons="accept,cancel,extra1,extra2"
            buttonlabelextra1="&apply.label;"
            buttonlabelextra2="&settings.label;"
            minwidth="527"
            persist="screenX screenY">
            <!-- <script type="text/javascript">
            <![CDATA[
              // avoid opening prefs in tab, workaround to bug 1414406
              var {
                classes: Cc,
                interfaces: Ci,
                utils: Cu
              } = Components;
              var chromewin = window.docShell.rootTreeItem.domWindow;
              if (chromewin.location.href !== 'chrome://tabmixplus/content/preferences/preferences.xhtml') {
                var gBrowser = chromewin.gBrowser;
                let kcTab = gBrowser.selectedTab;
                let previousTab;
                let lastAccessed  = 0;
                for (let tab of gBrowser.tabs) {
                  if (!tab._notselectedsinceload && !tab.getAttribute('pending') && tab._lastAccessed > lastAccessed && tab != kcTab) {
                    lastAccessed = tab._lastAccessed;
                    previousTab = tab;
                  }
                }
                gBrowser.selectedTab = previousTab;

                chromewin.setTimeout(() => {
                  chromewin.openDialog('chrome://tabmixplus/content/preferences/preferences.xhtml', 'tabmixplus_prefs', 'chrome,centerscreen,toolbar');
                }, 0);

                gBrowser.removeTab(kcTab);
              } else {
                setTimeout(function () {
                  var navwin = Cc['@mozilla.org/appshell/window-mediator;1']
                                   .getService(Ci.nsIWindowMediator).getMostRecentWindow('navigator:browser');
                  var {SessionStoreInternal} = Cu.import('resource:///modules/sessionstore/SessionStore.jsm', navwin);
                  var data = SessionStoreInternal._windows[navwin.__SSi];
                  if (data._closedTabs && data._closedTabs.length && data._closedTabs[0].state.entries[0].url === 'chrome://tabmixplus/content/preferences/preferences.xhtml')
                    data._closedTabs.shift();
                }, 0);
              }
            ]]>
            </script> -->

  <!-- scripts -->
  <script type="application/javascript" src="chrome://tabmixplus/content/preferences/prefs-ce.js"/>
  <script type="application/javascript" src="chrome://tabmixplus/content/preferences/checkbox_tmp-ce.js"/>
  <script type="application/javascript" src="chrome://tabmixplus/content/utils.js"/>
  <script type="application/javascript" src="chrome://tabmixplus/content/preferences/preferences.js"/>

  <prefpane id="paneLinks" label="&tab.links;" class="prefpane"
            src="chrome://tabmixplus/content/preferences/links.xhtml"/>
  <prefpane id="paneEvents" label="&tab.events;" class="prefpane"
            src="chrome://tabmixplus/content/preferences/events.xhtml"/>
  <prefpane id="paneAppearance" label="&tab.appearance;" class="prefpane"
            src="chrome://tabmixplus/content/preferences/appearance.xhtml"/>
  <prefpane id="paneMouse" label="&tab.mouse;" class="prefpane"
            src="chrome://tabmixplus/content/preferences/mouse.xhtml"/>
  <prefpane id="paneMenu" label="&tab.menu;" class="prefpane"
            src="chrome://tabmixplus/content/preferences/menu.xhtml"/>
  <prefpane id="paneSession" label="&tab.session;" class="prefpane"
            src="chrome://tabmixplus/content/preferences/session.xhtml"/>
  <prefpane id="paneIncompatible" label="Error" class="prefpane"
            src="chrome://tabmixplus/content/preferences/incompatible.xhtml"/>
  <prefpane id="broadcasters" hidden="true" class="prefpane">
    <preferences>
      <preference id="pref_singleWindow" name="extensions.tabmix.singleWindow" type="bool"
                  onchange="if (typeof gLinksPane == 'object') gLinksPane.singleWindow(this.value);"/>
      <preference id="pref_undoClose"    name="extensions.tabmix.undoClose"    type="bool"/>
    </preferences>
    <broadcasterset id="main:Broadcaster">
      <broadcaster id="obs_singleWindow" inverseDependency="true"/>
      <broadcaster id="obs_undoClose"/>
    </broadcasterset>
  </prefpane>

  <popupset>
    <menupopup id="tm-settings" position="before_start">
      <menuitem id="tm-defaults" label="&settings.default;" oncommand="defaultSetting();"/>
      <menuitem id="tm-import" label="&settings.import;" oncommand="importData();"/>
      <menuitem id="tm-export" label="&settings.export;" oncommand="exportData();"/>
      <menuitem id="syncPrefs" label="&settings.sync;" oncommand="toggleSyncPreference(); this.checked=!this.checked;" type="checkbox"/>
    </menupopup>
  </popupset>

</prefwindow>
